# Проектный документ DSL для квестов

## Краткое описание

Этот документ предлагает предметно-ориентированный язык (DSL) для определения и обработки квестов в кооперативной приключенческой игре Pulpulak. DSL заменит текущий императивный код обработки квестов на декларативную, расширяемую систему, которая сделает создание и модификацию квестов более интуитивными и поддерживаемыми.

## Цели

1. **Упростить создание квестов**: Позволить не-программистам создавать и изменять квесты
2. **Уменьшить дублирование кода**: Объединить общие паттерны в переиспользуемые конструкции DSL
3. **Улучшить поддерживаемость**: Отделить логику квестов от деталей реализации
4. **Обеспечить сложное поведение**: Поддержка ветвления, условий и динамических результатов
5. **Сохранить существующие возможности**: Поддержать всю текущую функциональность квестов

## Анализ текущей системы

### Сильные стороны
- Четкое разделение между данными и логикой
- Хорошо определенная структура квестов
- Интеграция с игровыми системами (NPC, локации, инвентарь)

### Ограничения
- Логика квестов разбросана по множеству обработчиков
- Ограниченная поддержка сложных условий
- Захардкоженные имена действий
- Сложно добавлять новые типы квестов без изменения кода

## Предлагаемая архитектура DSL

### 1. Язык определения квестов

```yaml
quest: princess_lost_relic
metadata:
  title: "Потерянная королевская реликвия"
  description: "Найти древний амулет, который пропал из сокровищницы"
  character: princess
  
triggers:
  - type: dialogue
    npc: royal_advisor
    condition: |
      outfit == "noble" AND 
      has_memory("kingdom_talked") AND
      NOT quest_started("princess_lost_relic")

steps:
  - id: get_quest
    description: "Поговорить с королевским советником о пропаже"
    requirements:
      location: throne_room
      npc: royal_advisor
    actions:
      - set_memory: "quest_accepted"
      - add_dialogue_option:
          npc: old_woman
          option: "ask_about_amulet"
    
  - id: investigate_forest
    description: "Поискать реликвию в лесу"
    requirements:
      location: forest
      has_talked: 
        npc: old_woman
        about: "amulet_location"
    actions:
      - reveal_location: "hidden_grove"
      - spawn_item:
          location: hidden_grove
          item: ancient_amulet
    
  - id: retrieve_amulet
    description: "Забрать амулет"
    requirements:
      location: hidden_grove
      has_item: ancient_amulet
    actions:
      - complete_quest
      
completion:
  rewards:
    items: [ancient_amulet]
    effects:
      - add_loyalty: { villagers: 10 }
      - unlock_achievement: "royal_hero"
  message: "Вы вернули потерянную реликвию!"
```

### 2. Язык условий

DSL поддерживает богатый синтаксис условий:

```
# Базовые условия
outfit == "noble"
location == "forest"
has_item("ancient_amulet")
has_memory("quest_accepted")

# Сложные условия
(outfit == "noble" OR has_title("royal_guest")) AND location == "throne_room"

# Условия состояния квестов
quest_completed("helper_secret_potion")
quest_step("princess_lost_relic", "investigate_forest")
quest_active("any")

# Условия NPC
npc_memory("old_woman", "helped_with_potion")
npc_loyalty("villagers") > 50
```

### 3. Язык действий

Действия определяют, что происходит при выполнении условий:

```yaml
# Действия с памятью
set_memory: "key"
set_npc_memory: { npc: "old_woman", key: "helped" }

# Действия с диалогами
add_dialogue_option:
  npc: "merchant"
  option: "trade_for_ingredient"
  
remove_dialogue_option:
  npc: "merchant"
  option: "ask_about_relic"

# Действия с состоянием мира
reveal_location: "hidden_grove"
spawn_item: { location: "forest", item: "mushroom" }
add_inventory: "healing_potion"

# Действия управления квестами
complete_quest
fail_quest: "reason"
jump_to_step: "step_id"
start_quest: "quest_id"

# Действия с персонажами
change_loyalty: { group: "villagers", amount: 10 }
trigger_scene: "celebration"
```

### 4. Архитектура обработки DSL

```
┌─────────────────┐     ┌──────────────┐     ┌───────────────┐
│  Определение    │────>│    Парсер    │────>│   Движок      │
│  квеста DSL     │     │              │     │  выполнения   │
└─────────────────┘     └──────────────┘     └───────────────┘
                                                      │
                                                      v
┌─────────────────┐     ┌──────────────┐     ┌───────────────┐
│   Менеджер      │<────│  Исполнитель │<────│  Вычислитель  │
│  состояния игры │     │              │     │               │
└─────────────────┘     └──────────────┘     └───────────────┘
```

### 5. Фазы реализации

#### Фаза 1: Основной парсер DSL и среда выполнения
- YAML/JSON парсер для определений квестов
- Вычислитель условных выражений
- Базовый исполнитель действий
- Интеграция с существующим состоянием игры

#### Фаза 2: Миграция существующих квестов
- Конвертация текущих квестов в формат DSL
- Поддержка обратной совместимости
- Комплексное тестирование

#### Фаза 3: Расширенные возможности
- Ветвление квестов и множественные концовки
- Динамическая генерация квестов
- Зависимости и цепочки квестов
- Визуальный редактор квестов (в будущем)

### 6. Пример: Сложный квест с ветвлением

```yaml
quest: moral_choice_quest
metadata:
  title: "Выбор судьбы"
  character: any

steps:
  - id: discover_plot
    description: "Узнать о заговоре"
    branches:
      - id: report_to_nobles
        condition: outfit == "noble"
        actions:
          - set_flag: "chose_nobles"
          - change_loyalty: { nobles: 20, villagers: -10 }
          
      - id: warn_villagers
        condition: outfit == "common"
        actions:
          - set_flag: "chose_villagers"
          - change_loyalty: { nobles: -10, villagers: 20 }
          
  - id: face_consequences
    description: "Столкнуться с последствиями выбора"
    dynamic_requirements:
      - if: has_flag("chose_nobles")
        then: 
          location: throne_room
          npc: royal_advisor
      - if: has_flag("chose_villagers")
        then:
          location: village_square
          npc: village_elder
```

### 7. Точки интеграции

DSL будет интегрироваться с существующими системами:

- **Система NPC**: Через триггеры диалогов и модификации памяти
- **Система локаций**: Через требования локаций и раскрытие новых мест
- **Система инвентаря**: Через награды предметами и требования
- **Состояние игры**: Через прямые модификации состояния и запросы

### 8. Преимущества над текущей системой

1. **Декларативность**: Квесты определяются как данные, а не код
2. **Валидация**: DSL можно проверить до выполнения
3. **Инструментарий**: Возможность создания редакторов и визуализации квестов
4. **Переиспользование**: Общие паттерны становятся примитивами DSL
5. **Расширяемость**: Новые возможности добавляются без изменения основного движка

### 9. Стратегия миграции

1. Реализовать парсер DSL и среду выполнения параллельно с существующей системой
2. Создать DSL определения для текущих квестов
3. Запустить обе системы параллельно для тестирования
4. Постепенно мигрировать обработчики квестов на использование движка DSL
5. Удалить старый код обработки квестов

### 10. Будущие улучшения

- **Шаблоны квестов**: Переиспользуемые паттерны квестов
- **Процедурные квесты**: Генерируемые из шаблонов и параметров
- **Цепочки квестов**: Многоквестовые сюжетные линии с зависимостями
- **Квесты от игроков**: Возможность создавать квесты друг для друга
- **Аналитика**: Отслеживание процента прохождения и выборов игроков

## Заключение

Предлагаемый DSL для квестов превратит создание квестов из задачи программирования в задачу создания контента, при этом предоставляя больше возможностей и гибкости, чем текущая система. Поэтапный подход к реализации обеспечивает плавный переход с минимальными нарушениями существующего геймплея.