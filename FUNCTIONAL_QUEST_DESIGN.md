# Functional Quest Design Document

## Философия дизайна

### Основная концепция
Квесты разрабатываются как композиции **чистых функций**, где каждое состояние игры может быть достигнуто через последовательное применение базовых операций: `move(location)` и `interact(npc, action)`. Это обеспечивает детерминированность, тестируемость и предсказуемость игрового процесса.

### Принципы тестируемости

**Функциональная композиция:**
```
initial_state 
  -> move(tavern) 
  -> interact(blacksmith, "ask_about_sword") 
  -> move(forest) 
  -> interact(merchant, "trade_potion") 
  -> final_state
```

**Ключевые принципы:**
1. **Детерминизм**: одинаковая последовательность действий всегда приводит к одинаковому результату
2. **Композиционность**: сложные квесты строятся из простых функций
3. **Изоляция**: каждый шаг квеста может быть протестирован независимо
4. **Обратимость**: состояние игры можно восстановить из истории действий

## Структура квеста

### Обязательные компоненты

1. **Нарратив** - описание сюжета и мотивации квеста
2. **Начальное состояние** - определение исходной позиции игрока
3. **Конечное состояние** - цель квеста и критерии завершения
4. **Путь выполнения** - последовательность функций для достижения цели
5. **Тесты** - автоматизированная проверка корректности квеста

### Шаблон квеста

```scheme
;; =============================================
;; QUEST NARRATIVE
;; =============================================
;; [Здесь размещается подробное описание квеста
;;  на естественном языке, объясняющее сюжет,
;;  мотивацию персонажей и общий ход событий]

(define-quest quest-name
  ;; Начальное состояние
  (initial-state
    (player-location "starting_location")
    (inventory '())
    (npc-states '()))
  
  ;; Конечное состояние  
  (goal-state
    (conditions
      (player-has-item "target_item")
      (npc-satisfied "quest_giver")))
  
  ;; Функциональный путь
  (solution-path
    (move "location1")
    (interact "npc1" "action1")
    (move "location2")
    (interact "npc2" "action2"))
  
  ;; Альтернативные пути
  (alternative-paths
    (path-1 ...)
    (path-2 ...)))
```

## Базовые функции

### Функции передвижения
- `(move location)` - перемещение в указанную локацию
- `(can-move? location)` - проверка доступности локации
- `(get-current-location)` - получение текущей позиции

### Функции взаимодействия
- `(interact npc action)` - взаимодействие с NPC
- `(can-interact? npc action)` - проверка возможности взаимодействия
- `(get-npc-state npc)` - получение состояния NPC

### Функции состояния
- `(get-inventory)` - получение инвентаря игрока
- `(has-item? item)` - проверка наличия предмета
- `(add-item item)` - добавление предмета
- `(remove-item item)` - удаление предмета

## Принципы тестирования

### Тестовые сценарии
Каждый квест должен включать:

1. **Позитивный тест** - проверка успешного выполнения
2. **Негативные тесты** - проверка неправильных действий
3. **Граничные случаи** - тестирование крайних ситуаций
4. **Тесты состояния** - проверка корректности промежуточных состояний

### Пример тестовой функции
```scheme
(define-test test-quest-name
  (test-case "successful-completion"
    (assert-equal 
      (execute-quest-path quest-name solution-path)
      goal-state))
  
  (test-case "invalid-move"
    (assert-error
      (move "non-existent-location")))
  
  (test-case "prerequisite-check"
    (assert-false
      (can-interact? "npc" "action" 
        (without-item "required-item")))))
```

## Структура нарративных описаний

### Обязательные элементы нарратива
1. **Контекст** - текущая ситуация в мире игры
2. **Проблема** - что нужно решить
3. **Мотивация** - почему игрок должен это делать
4. **Ожидаемый результат** - что произойдет после выполнения
5. **Ключевые персонажи** - кто участвует в квесте
6. **Важные локации** - где происходят события

### Пример нарратива
```
КВЕСТ: Тайное зелье для принцессы

КОНТЕКСТ: Принцесса тяжело больна после проклятия злой колдуньи. 
Придворные лекари бессильны, и только древнее зелье может спасти ее.

ПРОБЛЕМА: Рецепт зелья утерян, а ингредиенты рассеяны по всему королевству. 
Нужно найти мудреца, который помнит рецепт, и собрать редкие компоненты.

МОТИВАЦИЯ: Спасение принцессы не только вопрос чести, но и политической 
стабильности - без наследницы королевство погрузится в хаос.

ОЖИДАЕМЫЙ РЕЗУЛЬТАТ: Принцесса исцелится, королевство будет спасено, 
а игрок получит статус героя и ценную награду.

КЛЮЧЕВЫЕ ПЕРСОНАЖИ:
- Мудрец Эльдрин (хранитель древних знаний)
- Торговец редкостями Грим (поставщик ингредиентов)
- Стражник Маркус (контролирует доступ к королевским покоям)

ВАЖНЫЕ ЛОКАЦИИ:
- Башня мудреца (для получения рецепта)
- Рынок редкостей (для покупки ингредиентов)
- Королевские покои (для передачи зелья)
```

## Рекомендации по реализации

### DSL конструкции
- Используйте понятные имена для локаций и NPC
- Группируйте связанные действия в логические блоки
- Добавляйте комментарии для сложной логики
- Предусматривайте альтернативные пути решения

### Обработка ошибок
- Валидация входных параметров
- Понятные сообщения об ошибках
- Graceful degradation при неожиданных ситуациях

### Производительность
- Избегайте избыточных вычислений состояния
- Кэшируйте результаты дорогих операций
- Минимизируйте количество состояний для отслеживания

Этот подход обеспечивает создание надежных, тестируемых и понятных квестов, которые легко отлаживать и модифицировать.